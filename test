<?php
session_start();

// --- 1. CONNEXION DB ---
$paths = ['config/db.php', 'db.php', '../config/db.php'];
$db_found = false;
foreach ($paths as $p) {
    if (file_exists($p)) { require_once $p; $db_found = true; break; }
}
if (!$db_found) die("❌ Fichier db.php introuvable.");

// --- 2. AUTHENTIFICATION ---
if (!isset($_SESSION['user_id'])) {
    
    if (isset($_COOKIE['mon_site_auth'])) {
        
        $parts = explode('.', $_COOKIE['mon_site_auth']);
        
        if (count($parts) === 2) {
            $payload = $parts[0];
            $signature = $parts[1];

            $checkSignature = hash_hmac('sha256', $payload, SECRET_KEY);

            if (hash_equals($checkSignature, $signature)) {
                
                // ON RETIRE LES 4 CARACTÈRES ALÉATOIRES
                $cleanBase64 = substr($payload, 0, -4);
                
                $decoded = base64_decode($cleanBase64);

                if (strpos($decoded, '|') !== false) {
                    list($username, $date) = explode('|', $decoded);

                    $stmtAuth = $pdo->prepare("SELECT id, username FROM users WHERE username = ?");
                    $stmtAuth->execute([$username]);
                    $userFound = $stmtAuth->fetch(PDO::FETCH_ASSOC);

                    if ($userFound) {
                        $_SESSION['user_id'] = $userFound['id'];
                        $_SESSION['username'] = $userFound['username'];
                    }
                }
            }
        }
    }
}

if (!isset($_SESSION['user_id'])) {
    header('Location: login.php');
    exit;
}

$userId = $_SESSION['user_id']; 

$currentUser = false;
$pinnedProjects = [];
$allProjects = [];

if (isset($pdo)) {
    try {
        $stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");
        $stmt->execute([$userId]);
        $currentUser = $stmt->fetch(PDO::FETCH_ASSOC);

        $stmt = $pdo->prepare("SELECT * FROM projects WHERE owner_id = ? AND is_pinned = 1 ORDER BY updated_at DESC");
        $stmt->execute([$userId]);
        $pinnedProjects = $stmt->fetchAll(PDO::FETCH_ASSOC);

        $stmt = $pdo->prepare("SELECT * FROM projects WHERE owner_id = ? ORDER BY created_at DESC");
        $stmt->execute([$userId]);
        $allProjects = $stmt->fetchAll(PDO::FETCH_ASSOC);

    } catch (PDOException $e) { /* Silent fail */ }
}

if (!$currentUser) {
   header('Location: logout.php');
   exit;
}

function getProjectImage($id) {
    return "https://picsum.photos/seed/arcops{$id}/400/250"; 
}
?>